{"version":3,"file":"Waterfall-BknPVFru.js","sources":["../../src/components/Waterfall/src/Waterfall.vue","../../src/views/Components/Waterfall.vue"],"sourcesContent":["<script lang=\"ts\" setup>\nimport { propTypes } from '@/utils/propTypes'\nimport { useDesign } from '@/hooks/web/useDesign'\nimport { ref, nextTick, unref, onMounted, watch } from 'vue'\nimport { useEventListener, useIntersectionObserver } from '@vueuse/core'\nimport { debounce } from 'lodash-es'\n\nconst { getPrefixCls } = useDesign()\n\nconst prefixCls = getPrefixCls('waterfall')\n\nconst emit = defineEmits(['loadMore'])\n\nconst prop = defineProps({\n  data: propTypes.arrayOf(propTypes.any),\n  reset: propTypes.bool.def(true),\n  width: propTypes.number.def(200),\n  gap: propTypes.number.def(20),\n  props: propTypes.objectOf(propTypes.string).def({\n    src: 'src',\n    height: 'height'\n  }),\n  cols: propTypes.number.def(undefined),\n  loadingText: propTypes.string.def('加载中...'),\n  loading: propTypes.bool.def(false),\n  end: propTypes.bool.def(false),\n  endText: propTypes.string.def('没有更多了'),\n  autoCenter: propTypes.bool.def(true),\n  layout: propTypes.oneOf(['javascript', 'flex']).def('flex')\n})\n\nconst wrapEl = ref<HTMLDivElement>()\n\nconst heights = ref<number[]>([])\n\nconst wrapHeight = ref(0)\n\nconst wrapWidth = ref(0)\n\nconst loadMore = ref<HTMLDivElement>()\n\n// 首先确定列数 = 页面宽度 / 图片宽度\nconst innerCols = ref(0)\n\nconst filterData = ref<any[]>([])\n\nconst filterWaterfall = async () => {\n  filterData.value = []\n  const { props, width, gap } = prop\n  const data = prop.data as any[]\n  await nextTick()\n\n  const container = unref(wrapEl) as HTMLElement\n  if (!container) return\n  innerCols.value = prop.cols ?? Math.floor(container.clientWidth / (width + gap))\n\n  const length = data.length\n  for (let i = 0; i < length; i++) {\n    if (i < unref(innerCols)) {\n      heights.value[i] = data[i][props.height as string]\n      filterData.value.push({\n        ...data[i],\n        top: 0,\n        left: i * (width + gap)\n      })\n    } else {\n      // 其他行，先找出最矮的那一列 和 索引\n      // 假设最小高度是第一个元素\n      let minHeight = heights.value[0]\n      let index = 0\n      // 找出最小高度\n      for (let j = 1; j < unref(innerCols); j++) {\n        if (unref(heights)[j] < minHeight) {\n          minHeight = unref(heights)[j]\n          index = j\n        }\n      }\n\n      // 更新最矮高度\n      heights.value[index] += data[i][props.height as string] + gap\n      filterData.value.push({\n        ...data[i],\n        top: minHeight + gap,\n        left: index * (width + gap)\n      })\n    }\n  }\n  wrapHeight.value = Math.max(...unref(heights))\n  wrapWidth.value = unref(innerCols) * (width + gap) - gap\n}\n\nconst flexWaterfall = async () => {\n  const { width, gap } = prop\n  const data = prop.data as any[]\n  await nextTick()\n\n  const container = unref(wrapEl) as HTMLElement\n  if (!container) return\n  innerCols.value = prop.cols ?? Math.floor(container.clientWidth / (width + gap))\n\n  const length = data.length\n  // 根据列数，创建数组\n  const arr = new Array(unref(innerCols)).fill([])\n  // 循环data，依次插入到arr中\n  for (let i = 0; i < length; i++) {\n    const index = i % unref(innerCols)\n    arr[index] = [...arr[index], data[i]]\n  }\n  filterData.value = arr\n}\n\nconst initLayout = () => {\n  const { layout } = prop\n  if (layout === 'javascript') {\n    filterWaterfall()\n  } else if (layout === 'flex') {\n    flexWaterfall()\n  }\n}\n\nwatch(\n  () => [prop.data, prop.cols],\n  () => {\n    initLayout()\n  },\n  {\n    immediate: true\n  }\n)\n\nonMounted(() => {\n  if (unref(prop.reset)) {\n    useEventListener(window, 'resize', debounce(initLayout, 300))\n  }\n  useIntersectionObserver(\n    unref(loadMore),\n    ([{ isIntersecting }]) => {\n      if (isIntersecting && !prop.loading && !prop.end) {\n        emit('loadMore')\n      }\n    },\n    {\n      threshold: 0.1\n    }\n  )\n})\n</script>\n\n<template>\n  <div\n    :class=\"[\n      prefixCls,\n      'flex',\n      'items-center',\n      {\n        'justify-center': autoCenter\n      }\n    ]\"\n    ref=\"wrapEl\"\n    :style=\"{\n      height: `${layout === 'javascript' ? wrapHeight + 40 : 'auto'}px`\n    }\"\n  >\n    <template v-if=\"layout === 'javascript'\">\n      <div class=\"relative\" :style=\"{ width: `${wrapWidth}px`, height: `${wrapHeight + 40}px` }\">\n        <div\n          v-for=\"(item, $index) in filterData\"\n          :class=\"[\n            `${prefixCls}-item__${$index}`,\n            {\n              absolute: layout === 'javascript'\n            }\n          ]\"\n          :key=\"`water-${$index}`\"\n          :style=\"{\n            width: `${width}px`,\n            height: `${item[props.height as string]}px`,\n            top: `${item.top}px`,\n            left: `${item.left}px`\n          }\"\n        >\n          <img :src=\"item[props.src as string]\" class=\"w-full h-full block\" alt=\"\" srcset=\"\" />\n        </div>\n        <div\n          ref=\"loadMore\"\n          class=\"h-40px flex justify-center absolute w-full\"\n          :style=\"{\n            top: `${wrapHeight + gap}px`\n          }\"\n        >\n          {{ end ? endText : loadingText }}\n        </div>\n      </div>\n    </template>\n    <template v-else-if=\"layout === 'flex'\">\n      <div\n        class=\"relative flex pb-40px\"\n        :style=\"{\n          width: cols ? '100%' : 'auto'\n        }\"\n      >\n        <div\n          v-for=\"(item, $index) in filterData\"\n          :key=\"`waterWrap-${$index}`\"\n          class=\"flex-1\"\n          :style=\"{\n            marginRight: $index === filterData.length - 1 ? '0' : `${gap}px`\n          }\"\n        >\n          <div\n            v-for=\"(child, i) in item\"\n            :key=\"`waterWrap-${$index}-${i}`\"\n            :style=\"{\n              marginBottom: `${gap}px`,\n              width: cols ? '100%' : `${width}px`,\n              height: cols ? 'auto' : `${child[props.height as string]}px`\n            }\"\n          >\n            <img :src=\"child[props.src as string]\" class=\"w-full h-full block\" alt=\"\" srcset=\"\" />\n          </div>\n        </div>\n        <div\n          ref=\"loadMore\"\n          class=\"h-40px flex justify-center absolute w-full items-center\"\n          :style=\"{\n            bottom: 0\n          }\"\n        >\n          {{ end ? endText : loadingText }}\n        </div>\n      </div>\n    </template>\n  </div>\n</template>\n","<script setup lang=\"ts\">\nimport { Waterfall } from '@/components/Waterfall'\nimport { ContentWrap } from '@/components/ContentWrap'\nimport { useI18n } from '@/hooks/web/useI18n'\nimport Mock from 'mockjs'\nimport { ref, unref } from 'vue'\nimport { toAnyString } from '@/utils'\n\nconst data = ref<any>([])\n\nconst getList = () => {\n  const list: any = []\n  for (let i = 0; i < 20; i++) {\n    // 随机 100, 500 之间的整数\n    const height = Mock.Random.integer(100, 500)\n    const width = Mock.Random.integer(100, 500)\n    list.push(\n      Mock.mock({\n        width,\n        height,\n        id: toAnyString(),\n        // http更换为https\n        image_uri: Mock.Random.image(`${width}x${height}`).replace('http://', 'https://')\n      })\n    )\n  }\n  data.value = [...unref(data), ...list]\n  if (unref(data).length >= 60) {\n    end.value = true\n  }\n}\ngetList()\n\nconst { t } = useI18n()\n\nconst loading = ref(false)\n\nconst end = ref(false)\n\nconst loadMore = () => {\n  loading.value = true\n  setTimeout(() => {\n    getList()\n    loading.value = false\n  }, 1000)\n}\n</script>\n\n<template>\n  <ContentWrap :title=\"t('router.waterfall')\">\n    <Waterfall\n      :data=\"data\"\n      :loading=\"loading\"\n      :end=\"end\"\n      :props=\"{\n        src: 'image_uri',\n        height: 'height'\n      }\"\n      @load-more=\"loadMore\"\n    />\n  </ContentWrap>\n</template>\n"],"names":["getPrefixCls","useDesign","prefixCls","emit","__emit","prop","__props","wrapEl","ref","heights","wrapHeight","wrapWidth","loadMore","innerCols","filterData","filterWaterfall","__async","props","width","gap","data","nextTick","container","unref","_a","length","i","__spreadProps","__spreadValues","minHeight","index","j","flexWaterfall","arr","initLayout","layout","watch","onMounted","useEventListener","debounce","useIntersectionObserver","isIntersecting","getList","list","height","Mock","toAnyString","end","t","useI18n","loading"],"mappings":"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"}